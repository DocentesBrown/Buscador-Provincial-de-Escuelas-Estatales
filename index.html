<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscador de Escuelas Estatales - Docentes Brown</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3efdc;
      color: #24496e;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #24496e;
      color: white;
      padding: 1rem;
      border-bottom: 5px solid #da6863;
    }
    h1 { margin: 0; }
    h2 { font-size: 1rem; margin-top: 0.5rem; color: #f3efdc; }
    h2 a { color: #da6863; text-decoration: none; font-weight: bold; }
    .filters { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin: 1rem; }
    select { padding: 0.5rem; border-radius: 8px; border: 1px solid #3d8fb0; width: 90%; max-width: 400px; }
    .results { display: flex; flex-direction: column; align-items: center; margin: 1rem; }
    .card { background-color: white; border: 2px solid #3d8fb0; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1rem; margin: 0.5rem; width: 90%; max-width: 600px; text-align: left; }
    .btn { display: inline-block; background-color: #da6863; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 0.5rem; }
    footer { background-color: #4d3069; color: white; padding: 1rem; margin-top: 1rem; }
    #contador { font-weight: bold; color: #f3efdc; }
  </style>
</head>
<body>
  <header>
    <h1>Buscador de Escuelas Estatales</h1>
    <h2>Optimizado por <a href="https://www.instagram.com/docentesbrown" target="_blank">@docentesbrown</a></h2>
  </header>

  <section class="filters">
    <select id="regionFilter"><option value="">Seleccionar Regi√≥n</option></select>
    <select id="distritoFilter"><option value="">Seleccionar Distrito</option></select>
    <select id="nivelFilter"><option value="">Seleccionar Nivel</option></select>
    <select id="modalidadFilter"><option value="">Seleccionar Modalidad</option></select>
    <select id="numeroFilter"><option value="">Seleccionar N¬∫ de Escuela</option></select>
  </section>

  <section class="results" id="results"></section>

  <footer>
    <p id="contador">Cargando visitas...</p>
    <a class="btn" href="https://cafecito.app/docentesbrown" target="_blank">‚òï Don√° un Cafecito</a>
  </footer>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxk9mBO2U4JKTaj4iLtYGzw4KWh7GNxfAqfOIj_Dgc1ciDLb7MKGDfnkvfmuFwOg/pub?gid=1973952134&single=true&output=csv';
    let allData = []; 

    // --- NUEVA FUNCI√ìN PARA CORREGIR EL ERROR DE COLUMNAS ---
    function parseCSV(text) {
      const rows = [];
      // Primero separamos por l√≠neas
      const lines = text.trim().split(/\r?\n/);

      for (const line of lines) {
        const rowData = [];
        let currentField = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            // Maneja comillas de inicio/fin y comillas escapadas ("")
            if (inQuotes && line[i + 1] === '"') {
              currentField += '"';
              i++; // Saltamos la comilla escapada
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            rowData.push(currentField);
            currentField = '';
          } else {
            currentField += char;
          }
        }
        rowData.push(currentField); // Agregamos el √∫ltimo campo
        
        // Limpiamos las comillas que quedaron al inicio/fin de cada campo
        rows.push(rowData.map(field => field.trim().replace(/^"|"$/g, '')));
      }
      return rows;
    }

    async function loadData() {
      try {
        const response = await fetch(sheetUrl);
        const csvText = await response.text();
        
        // --- L√çNEA CORREGIDA ---
        // Usamos la nueva funci√≥n en lugar de los splits simples
        const rows = parseCSV(csvText); 
        
        const headers = rows[0].map(h => 
          h.trim().toLowerCase().replace(/ /g, '_')
        );

        allData = rows.slice(1).map(row => 
          Object.fromEntries(headers.map((h, i) => [h, row[i] || '']))
        );

        // Verificaci√≥n r√°pida en la consola (opcional)
        // console.log("Headers detectados:", headers);
        // console.log("Ejemplo de datos:", allData[0]);

        populateFilters(allData);
        setupFilterListeners(allData);
      } catch (error) {
        document.getElementById('results').innerHTML = `<p style='color:red'>Error cargando datos: ${error.message}</p>`;
        console.error("Error en loadData:", error);
      }
    }

    function populateFilters(data) {
      const regions = [...new Set(data.map(d => d.region_educativa).filter(Boolean))].sort();
      fillSelect('regionFilter', regions);
    }

    function fillSelect(id, options) {
      const select = document.getElementById(id);
      const defaultOption = select.querySelector('option[value=""]'); 
      select.innerHTML = ''; 
      select.appendChild(defaultOption); 
      
      options.forEach(o => {
        const option = document.createElement('option');
        option.value = o;
        option.textContent = o;
        select.appendChild(option);
      });
    }

    function setupFilterListeners(data) {
      const region = document.getElementById('regionFilter');
      const distrito = document.getElementById('distritoFilter');
      const nivel = document.getElementById('nivelFilter');
      const modalidad = document.getElementById('modalidadFilter');
      const numero = document.getElementById('numeroFilter');

      region.addEventListener('change', () => {
        const filtered = data.filter(d => d.region_educativa === region.value);
        fillSelect('distritoFilter', [...new Set(filtered.map(d => d.distrito).filter(Boolean))].sort());
        fillSelect('nivelFilter', []);
        fillSelect('modalidadFilter', []);
        fillSelect('numeroFilter', []);
        document.getElementById('results').innerHTML = '';
      });

      distrito.addEventListener('change', () => {
        const filtered = data.filter(d => 
          d.region_educativa === region.value &&
          d.distrito === distrito.value
        );
        // Esta l√≠nea ahora deber√≠a funcionar bien
        fillSelect('nivelFilter', [...new Set(filtered.map(d => d.nivel).filter(Boolean))].sort());
        fillSelect('modalidadFilter', []);
        fillSelect('numeroFilter', []);
        document.getElementById('results').innerHTML = '';
      });

      nivel.addEventListener('change', () => {
        const filtered = data.filter(d => 
          d.region_educativa === region.value &&
          d.distrito === distrito.value &&
          d.nivel === nivel.value
        );
        fillSelect('modalidadFilter', [...new Set(filtered.map(d => d.modalidad).filter(Boolean))].sort());
        fillSelect('numeroFilter', []);
        document.getElementById('results').innerHTML = '';
      });

      modalidad.addEventListener('change', () => {
        const filtered = data.filter(d => 
          d.region_educativa === region.value &&
          d.distrito === distrito.value &&
          d.nivel === nivel.value &&
          d.modalidad === modalidad.value
        );
        fillSelect('numeroFilter', [...new Set(filtered.map(d => d.nro_escuela).filter(Boolean))].sort());
        document.getElementById('results').innerHTML = '';
      });

      numero.addEventListener('change', () => {
        const filtered = data.filter(d => 
          d.region_educativa === region.value &&
          d.distrito === distrito.value &&
          d.nivel === nivel.value &&
          d.modalidad === modalidad.value &&
          d.nro_escuela === numero.value
        );
        displayResults(filtered);
      });
    }

    function displayResults(filtered) {
      const container = document.getElementById('results');
      container.innerHTML = '';
      if (filtered.length === 0) {
        container.innerHTML = '<p>No se encontraron resultados para esta combinaci√≥n de filtros.</p>';
        return;
      }

      filtered.forEach(d => {
        const query = d.latitud && d.longitud 
            ? `${d.latitud},${d.longitud}` 
            : `${d.nombre} ${d.calle} ${d.nro_calle} ${d.localidad}`;
        const loc = `http://googleusercontent.com/maps.google.com/8{encodeURIComponent(query)}`;
        
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <strong>${d.nombre}</strong><br>
          Regi√≥n: ${d.region_educativa}<br>
          Distrito: ${d.distrito}<br>
          Nivel: ${d.nivel}<br>
          Modalidad: ${d.modalidad}<br>
          N¬∫ Escuela: ${d.nro_escuela}<br>
          Calle: ${d.calle} ${d.nro_calle}<br>
          Localidad: ${d.localidad}<br>
          Tel: (${d.caracteristica_telefonica}) ${d.nro_telefono}<br>
          Email: ${d.email}<br>
          Tipo: ${d.tipo_organizacion}<br>
          Desfavorabilidad: ${d.desfavorabilidad}<br>
          <a class='btn' href='${loc}' target='_blank'>üìç Ver ubicaci√≥n</a>
        `;
        container.appendChild(card);
      });
    }

    async function loadCounter() {
      try {
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNNH-wuSaxPFutY94tKcrhwDknSefi0D_z8uIBEILzcbrObRTKCLqblHax0TO0nPfKu3dok8rRoCuU/pub?output=csv';
        const res = await fetch(url);
        const text = await res.text();
        const visitas = text.split(',')[0].trim();
        document.getElementById('contador').innerText = `Visitas: ${visitas}`;
      } catch {
        document.getElementById('contador').innerText = 'Visitas: -';
      }
    }

    loadData();
    loadCounter();
  </script>
</body>
</html>
