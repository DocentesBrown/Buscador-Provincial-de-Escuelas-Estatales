<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscador de Escuelas Estatales - Docentes Brown</title>
  <style>
    /* ... (CSS sin cambios) ... */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3efdc;
      color: #24496e;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #24496e;
      color: white;
      padding: 1rem;
      border-bottom: 5px solid #da6863;
    }
    h1 { margin: 0; }
    h2 { font-size: 1rem; margin-top: 0.5rem; color: #f3efdc; }
    h2 a { color: #da6863; text-decoration: none; font-weight: bold; }
    .filters { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin: 1rem; }
    select { padding: 0.5rem; border-radius: 8px; border: 1px solid #3d8fb0; width: 90%; max-width: 400px; }
    .results { display: flex; flex-direction: column; align-items: center; margin: 1rem; }
    .card { background-color: white; border: 2px solid #3d8fb0; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1rem; margin: 0.5rem; width: 90%; max-width: 600px; text-align: left; }
    .btn { display: inline-block; background-color: #da6863; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 0.5rem; }
    footer { background-color: #4d3069; color: white; padding: 1rem; margin-top: 1rem; }
    #contador { font-weight: bold; color: #f3efdc; }
  </style>
</head>
<body>
  <header>
    <h1>Buscador de Escuelas Estatales</h1>
    <h2>Optimizado por <a href="https://www.instagram.com/docentesbrown" target="_blank">@docentesbrown</a></h2>
    <h2>Si te sirvi√≥ este buscador invitanos un cafecito, tu aporte nos acompa√±a para seguir creciendo</h2>
  </header>

  <section class="filters">
    <select id="regionFilter"><option value="">Seleccionar Regi√≥n</option></select>
    <select id="distritoFilter"><option value="">Seleccionar Distrito</option></select>
    <select id="nivelFilter"><option value="">Seleccionar Nivel</option></select>
    <select id="modalidadFilter"><option value="">Seleccionar Modalidad</option></select>
    <select id="numeroFilter"><option value="">Seleccionar N¬∫ de Escuela</option></select>
  </section>

  <section class="results" id="results"></section>

  <footer>
    <p id="contador">Cargando visitas...</p>
    <a class="btn" href="https://cafecito.app/docentesbrown" target="_blank">‚òï Don√° un Cafecito</a>
  </footer>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxk9mBO2U4JKTaj4iLtYGzw4KWh7GNxfAqfOIj_Dgc1ciDLb7MKGDfnkvfmuFwOg/pub?gid=1973952134&single=true&output=csv';
    let allData = []; 

    function parseCSV(text) {
      const rows = [];
      // Se a√±ade manejo de l√≠neas vac√≠as y se asegura que haya un salto de l√≠nea consistente
      const lines = text.trim().split(/\r?\n/).filter(line => line.length > 0); 

      for (const line of lines) {
        const rowData = [];
        let currentField = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              currentField += '"';
              i++; 
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            rowData.push(currentField);
            currentField = '';
          } else {
            currentField += char;
          }
        }
        rowData.push(currentField); 
        
        // Se mapea y se eliminan las comillas alrededor, asegurando un campo limpio.
        rows.push(rowData.map(field => field.trim().replace(/^"|"$/g, '')));
      }
      return rows;
    }

    async function loadData() {
      try {
        const response = await fetch(sheetUrl);
        const csvText = await response.text();
        
        const rows = parseCSV(csvText); 
        
        if (rows.length === 0) {
            document.getElementById('results').innerHTML = `<p style='color:orange'>El archivo de datos est√° vac√≠o o es inaccesible.</p>`;
            return;
        }

        const headers = rows[0].map(h => 
          h.trim().toLowerCase().replace(/ /g, '_').replace(/[^a-z0-9_]/g, '') // Limpieza de encabezados m√°s estricta
        );

        allData = rows.slice(1).map(row => {
            const dataObject = {};
            headers.forEach((h, i) => {
                dataObject[h] = row[i] || '';
            });
            return dataObject;
        });

        populateFilters(allData);
        setupFilterListeners(allData);
      } catch (error) {
        document.getElementById('results').innerHTML = `<p style='color:red'>Error cargando datos: ${error.message}. Verifica la URL del Google Sheet.</p>`;
      }
    }

    function populateFilters(data) {
      const regions = [...new Set(data.map(d => d.region_educativa).filter(Boolean))].sort();
      fillSelect('regionFilter', regions);
    }

    function fillSelect(id, options) {
      const select = document.getElementById(id);
      // Se guarda la opci√≥n por defecto
      const defaultOption = select.querySelector('option[value=""]').cloneNode(true) || new Option(select.id.replace('Filter', ''), ''); 
      select.innerHTML = ''; 
      select.appendChild(defaultOption); 
      
      options.forEach(o => {
        const option = document.createElement('option');
        option.value = o;
        option.textContent = o;
        select.appendChild(option);
      });
    }

    function setupFilterListeners(data) {
      const region = document.getElementById('regionFilter');
      const distrito = document.getElementById('distritoFilter');
      const nivel = document.getElementById('nivelFilter');
      const modalidad = document.getElementById('modalidadFilter');
      const numero = document.getElementById('numeroFilter');

      // Funcionalidad de filtros simplificada para evitar repetici√≥n
      function updateFilters(currentFilter, nextFilters) {
        let filtered = data;
        const regionVal = region.value;
        const distritoVal = distrito.value;
        const nivelVal = nivel.value;
        const modalidadVal = modalidad.value;

        if (regionVal) filtered = filtered.filter(d => d.region_educativa === regionVal);
        if (distritoVal) filtered = filtered.filter(d => d.distrito === distritoVal);
        if (nivelVal) filtered = filtered.filter(d => d.nivel === nivelVal);
        if (modalidadVal) filtered = filtered.filter(d => d.modalidad === modalidadVal);

        if (nextFilters.includes('distritoFilter')) {
          fillSelect('distritoFilter', [...new Set(filtered.map(d => d.distrito).filter(Boolean))].sort());
        }
        if (nextFilters.includes('nivelFilter')) {
          fillSelect('nivelFilter', [...new Set(filtered.map(d => d.nivel).filter(Boolean))].sort());
        }
        if (nextFilters.includes('modalidadFilter')) {
          fillSelect('modalidadFilter', [...new Set(filtered.map(d => d.modalidad).filter(Boolean))].sort());
        }
        if (nextFilters.includes('numeroFilter')) {
          fillSelect('numeroFilter', [...new Set(filtered.map(d => d.nro_escuela).filter(Boolean))].sort());
        }

        document.getElementById('results').innerHTML = '';
        
        // Muestra resultados solo si Modalidad o N√∫mero cambian (que implica que hay suficientes filtros)
        if (currentFilter === 'modalidadFilter' || currentFilter === 'numeroFilter') {
             // Si el √∫ltimo filtro es N√∫mero y est√° vac√≠o, mostramos todos los resultados del filtro anterior.
             if (currentFilter === 'numeroFilter' && numero.value === "") {
                const prevFiltered = data.filter(d => 
                    d.region_educativa === region.value &&
                    d.distrito === distrito.value &&
                    d.nivel === nivel.value &&
                    d.modalidad === modalidad.value
                );
                displayResults(prevFiltered);
             } else {
                displayResults(filtered);
             }
        }
      }

      region.addEventListener('change', () => updateFilters('regionFilter', ['distritoFilter', 'nivelFilter', 'modalidadFilter', 'numeroFilter']));
      distrito.addEventListener('change', () => updateFilters('distritoFilter', ['nivelFilter', 'modalidadFilter', 'numeroFilter']));
      nivel.addEventListener('change', () => updateFilters('nivelFilter', ['modalidadFilter', 'numeroFilter']));
      modalidad.addEventListener('change', () => updateFilters('modalidadFilter', ['numeroFilter']));
      numero.addEventListener('change', () => updateFilters('numeroFilter', [])); // Solo llama a displayResults dentro de la funci√≥n updateFilters
    }

    // --- FUNCI√ìN 'displayResults' CON LA CORRECCI√ìN DE URL DEFINITIVA ---
    function displayResults(filtered) {
      const container = document.getElementById('results');
      container.innerHTML = '';
      if (filtered.length === 0) {
        container.innerHTML = '<p>No se encontraron resultados para esta combinaci√≥n de filtros.</p>';
        return;
      }

      filtered.forEach(d => {
        let query = '';

        if (d.latitud && d.longitud && d.latitud !== '' && d.longitud !== '') {
          // Si tiene lat/long, usar coordenadas
          query = `${d.latitud},${d.longitud}`;
        } else {
          // Si no tiene, usar la direcci√≥n completa para la b√∫squeda
          query = `${d.nombre} ${d.calle} ${d.nro_calle} ${d.localidad} ${d.distrito}`;
        }
        
        // ‚úÖ CORRECCI√ìN FINAL: Se usa la URL de Google Maps Search API correcta.
        const loc = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <strong>${d.nombre || 'Nombre no disponible'}</strong><br>
          Regi√≥n: ${d.region_educativa || ''}<br>
          Distrito: ${d.distrito || ''}<br>
          Clave: ${d.clave || ''}<br>
          Nivel: ${d.nivel || ''}<br>
          Modalidad: ${d.modalidad || ''}<br>
          N¬∫ Escuela: ${d.nro_escuela || ''}<br>
          Calle: ${d.calle || ''} ${d.nro_calle || ''}<br>
          Entre: ${d.calle_lateral_derecha || ''} y ${d.calle_lateral_izquierda || ''}<br>
          Localidad: ${d.localidad || ''}<br>
          Tel: (${d.caracteristica_telefonica || ''}) ${d.nro_telefono || ''}<br>
          Email: ${d.email || ''}<br>
          Tipo: ${d.tipo_organizacion || ''}<br>
          Desfavorabilidad: ${d.desfavorabilidad || ''}<br>
          <a class='btn' href='${loc}' target='_blank'>üìç Ver ubicaci√≥n</a>
        `;
        container.appendChild(card);
      });
    }

    async function loadCounter() {
      // PEG√Å AC√Å TU "URL de la aplicaci√≥n web" que copiaste en el paso 6
      const url = 'https://script.google.com/macros/s/AKfycbyKykDszLonwKbCOozT3cgbctSayhhWR2T3vDf5ncMX296E-p6EytJuvWWPr6MO6xhg/exec';

      try {
        const res = await fetch(url, { cache: 'no-store' });
        const visitas = await res.text();
        document.getElementById('contador').innerText = `Visitantes totales: ${visitas}`;
      } catch {
        document.getElementById('contador').innerText = 'Visitantes totales: -';
      }
    }

    loadData();
    loadCounter();
  </script>
</body>
</html>
